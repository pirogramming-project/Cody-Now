{% extends "base.html" %} {% load static %} {% block content %}

<h2>내 옷장</h2>
<button id="toggle-showbookmark-btn">
  {% if show_bookmarked %} 모든 옷 보기 {% else %} 북마크한 옷만 보기
  <!-- 줄바꿈 유지 -->
  {% endif %}
</button>
<div id="closet">
  {% for outfit in outfits %}
  <div class="outfit-card" id="outfit-{{ outfit.id }}">
    {% if recommendation_count > 0 %}
    <a href="{% url 'closet:history_recommendation' outfit.id %}">
      <img
        src="{{ outfit.image.url }}"
        alt="Outfit Image"
        class="uniform-image"
      />
    </a>
    <div class="overlay">기록 보기</div>
    {% else %}
    <img
      src="{{ outfit.image.url }}"
      alt="Outfit Image"
      class="uniform-image"
      onclick="goToInputPage({{ outfit.id }})"
    />
    {% endif %}
    <div class="buttons">
      <button onclick="toggleBookmark({{ outfit.id }})">
        {% if outfit.bookmarked %} ★ {% else %} ☆ {% endif %}
      </button>
      <button onclick="deleteOutfit({{ outfit.id }})">삭제</button>
    </div>
  </div>
  {% endfor %}
</div>
<div id="add-clothes-container">
  <a href="{%url 'closet:upload_outfit'%}" class="add-clothes-button"
    >옷장 채우기</a
  >
</div>
<script>
    window.onload = async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const outfitId = urlParams.get("id");

        if (outfitId) {
            try {
                let response = await fetch(`/api/outfit/${outfitId}/`);
                let data = await response.json();

                if (data.image_url) {
                    document.getElementById("preview-image").src = data.image_url;
                    document.getElementById("preview-image").style.display = "block";
                    document.getElementById("image-preview-icon").style.display = "none";
                }

                if (data.analysis_result) {
                    document.getElementById("result").textContent = JSON.stringify(data.analysis_result, null, 2);
                    document.getElementById("result-section").style.display = "block";
                }

                if (data.cody_recommendation) {
                    document.getElementById("cody-recommendation").textContent = data.cody_recommendation;
                    document.getElementById("cody-result").style.display = "block";
                }
            } catch (error) {
                console.error("데이터를 불러오는 중 오류 발생:", error);
            }
        }
    };
</script>
<script>
   function toggleBookmark(outfitId) {
    fetch(`/bookmark/${outfitId}/`, {
      method: "POST",
      headers: { "X-CSRFToken": "{{ csrf_token }}" },
    })
      .then((response) => response.json())
      .then((data) => {
        alert(data.message);
        location.reload(); // 상태를 갱신합니다.
      })
      .catch((error) => {
        console.error("Error:", error);
      });
  }

  function deleteOutfit(outfitId) {
    if (confirm("정말 삭제하시겠습니까?")) {
      fetch(`/delete/${outfitId}/`, {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
      })
        .then((response) => response.json())
        .then((data) => {
          alert(data.message);
          document.getElementById(`outfit-${outfitId}`).remove();
        })
        .catch((error) => {
          console.error("Error:", error);
        });
    }
  }
  document.getElementById("toggle-showbookmark-btn").onclick = function () {
    const currentURL = new URL(window.location.href);
    if (currentURL.searchParams.get("bookmarked") === "true") {
      currentURL.searchParams.delete("bookmarked"); // 모든 옷 보기
    } else {
      currentURL.searchParams.set("bookmarked", "true"); // 북마크된 옷만 보기
    }
    window.location.href = currentURL.toString();
  };

  function goToInputPage(outfitId) {
    window.location.href = `{% url 'closet:upload_outfit' %}?id=${outfitId}`;
  }
</script>
 

<style>
  #closet {
    display: grid;
    grid-template-columns: 1fr 1fr;
  }
  .uniform-image {
    width: 200px;
    height: 200px;
    object-fit: cover;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .outfit-card {
    margin-bottom: 20px;
  }
  .buttons {
    margin-top: 10px;
  }
  .buttons button {
    margin-right: 5px;
  }

  #add-clothes-container {
    margin-top: 30px;
    text-align: center;
  }
  .add-clothes-button {
    display: inline-block;
    padding: 10px 20px;
    background-color: #4caf50;
    color: #fff;
    text-decoration: none;
    font-size: 16px;
    border-radius: 5px;
    transition: background-color 0.3s ease;
  }
  .add-clothes-button:hover {
    background-color: #45a049;
  }
</style>

{% endblock %}
