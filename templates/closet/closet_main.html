{% extends "base.html" %}
{% block content %}
<h2>내 옷장</h2>
<div id="closet">
    <button id="toggle-showbookmark-btn">
        {% if show_bookmarked %} 모든 옷 보기 {% else %} 북마크한 옷만 보기 {% endif %}
    </button>
    <div class="category-filter" id="upload-history-category-filter">
        <button class="filter-btn active" data-category="all">전체</button>
        <!-- JS로 동적으로 카테고리 버튼 추가 -->
    </div>
    <div id="outfit-list">
        {% for outfit in outfits %}
        <div class="outfit-card" id="outfit-{{ outfit.id }}" data-category="{{ outfit.category.id }}">
            <img src="{{ outfit.image.url }}" alt="Outfit Image" class="uniform-image" onclick="goToInputPage({{ outfit.id }})">
            <div class="buttons">
                <button onclick="toggleBookmark({{ outfit.id }})">
                    {% if outfit.bookmarked %} ★ {% else %} ☆ {% endif %}
                </button>
                <button onclick="deleteOutfit({{ outfit.id }})">삭제</button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<div id="add-clothes-container">
    <a href="{% url 'closet:upload_outfit' %}" class="add-clothes-button">옷장 채우기</a>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    setupCategoryHandlers();
    observeCategoryChanges();
    loadClosetItems();
});

function toggleBookmark(outfitId) {
    fetch(`/bookmark/${outfitId}/`, {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        location.reload();
    })
    .catch(error => {
        console.error("Error:", error);
    });
}

function deleteOutfit(outfitId) {
    if (confirm("정말 삭제하시겠습니까?")) {
        fetch(`/delete/${outfitId}/`, {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            document.getElementById(`outfit-${outfitId}`).remove();
        })
        .catch(error => {
            console.error("Error:", error);
        });
    }
}

document.getElementById("toggle-showbookmark-btn").onclick = function() {
    const currentURL = new URL(window.location.href);
    if (currentURL.searchParams.get("bookmarked") === "true") {
        currentURL.searchParams.delete("bookmarked");
    } else {
        currentURL.searchParams.set("bookmarked", "true");
    }
    window.location.href = currentURL.toString();
};

function goToInputPage(outfitId) {
    window.location.href = `{% url 'closet:upload_outfit' %}?id=${outfitId}`;
}

// 카테고리 필터링 기능
function loadClosetItems(category = "all", updateFilters = true) {
    fetch(`/closet-items/?category=${category}`)
        .then(response => response.json())
        .then(data => {
            const outfitList = document.getElementById("outfit-list");
            outfitList.innerHTML = '';

            if (data.outfits.length === 0) {
                outfitList.innerHTML = "<p>옷장에 저장된 옷이 없습니다.</p>";
                return;
            }

            data.outfits.forEach(item => {
                const div = document.createElement('div');
                div.classList.add('outfit-card');
                div.id = `outfit-${item.id}`;
                div.dataset.category = item.category_id;

                div.innerHTML = `
                    <img src="${item.image}" alt="Outfit Image" class="uniform-image" onclick="goToInputPage(${item.id})">
                    <div class="buttons">
                        <button onclick="toggleBookmark(${item.id})">${item.bookmarked ? '★' : '☆'}</button>
                        <button onclick="deleteOutfit(${item.id})">삭제</button>
                    </div>
                `;
                outfitList.appendChild(div);
            });

            if (updateFilters) {
                updateCategoryFilters(data.user_categories, category);
            }
        })
        .catch(error => console.error('옷장 로딩 실패:', error));
}

function updateCategoryFilters(categories, activeCategory) {
    const filterContainer = document.getElementById("upload-history-category-filter");
    filterContainer.innerHTML = '';

    const allButton = document.createElement("button");
    allButton.classList.add("filter-btn");
    allButton.dataset.category = "all";
    allButton.innerText = "전체";
    if (activeCategory === "all") allButton.classList.add("active");
    allButton.addEventListener("click", function () {
        setActiveCategory("all");
        loadClosetItems("all", false);
    });
    filterContainer.appendChild(allButton);

    categories.forEach(category => {
        const button = document.createElement("button");
        button.classList.add("filter-btn");
        button.dataset.category = category.id;
        button.innerText = category.name;
        if (activeCategory === category.id.toString()) button.classList.add("active");
        button.addEventListener("click", function () {
            setActiveCategory(category.id);
            loadClosetItems(category.id, false);
        });
        filterContainer.appendChild(button);
    });

    bindFilterEvents();
}

function setActiveCategory(category) {
    document.querySelectorAll(".filter-btn").forEach(btn => {
        btn.classList.remove("active");
        if (btn.dataset.category === category.toString()) {
            btn.classList.add("active");
        }
    });
}

function bindFilterEvents() {
    document.querySelectorAll(".filter-btn").forEach(button => {
        button.addEventListener("click", function () {
            setActiveCategory(this.dataset.category);
            loadClosetItems(this.dataset.category, false);
        });
    });
}

function observeCategoryChanges() {
    const categoryList = document.getElementById("upload-history-category-filter");
    if (!categoryList) return;

    const categoryObserver = new MutationObserver((mutationsList) => {
        let shouldUpdate = false;

        mutationsList.forEach(mutation => {
            if (mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0) {
                shouldUpdate = true;
            }
        });

        if (shouldUpdate) {
            const activeCategory = document.querySelector(".filter-btn.active");
            const activeCategoryId = activeCategory ? activeCategory.dataset.category : "all";

            updateCategoryFilters(getCategoriesFromDOM(), activeCategoryId);
        }
    });

    categoryObserver.observe(categoryList, { childList: true });
}

function getCategoriesFromDOM() {
    return [...document.querySelectorAll("#upload-history-category-filter .filter-btn")]
        .filter(btn => btn.dataset.category !== "all")
        .map(btn => ({ id: btn.dataset.category, name: btn.innerText }));
}
</script>

<style>
.uniform-image {
    width: 200px;
    height: 200px;
    object-fit: cover;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.outfit-card { margin-bottom: 20px; }
.buttons { margin-top: 10px; }
.buttons button { margin-right: 5px; }
</style>
{% endblock %}
