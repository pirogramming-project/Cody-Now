{% load static %}
<style>
  /* 슬라이드 애니메이션 스타일 추가 */

  #show-category-slider {
    position: fixed;
    bottom: -100%;
    display: none;
    left: 50%; /* 왼쪽을 화면의 50%로 지정 */
    transform: translateX(-50%); /* 중앙 정렬 */
    width: 100%;
    max-width: 600px;
    background: white;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
    transition: bottom 0.3s ease-in-out;
    border-radius: 10px 10px 0 0;
    z-index: 100;
    height: 70%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .category-selection {
    width: 90%;
  }
  .category-top > h5 {
    cursor: pointer;
  }
  .show-slide {
    display: flex !important; /* 슬라이드가 열릴 때 flex로 변경 */
    bottom: 0 !important;
  }
  .category-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    border-bottom: 1px solid #ddd;
  }

  .category-name {
    font-size: 16px;
  }

  .save-to-closet-btn {
    background-color: black;
    width: 80%;
    height: 50px;
    color: white;
    border: none;
    padding: 10px 15px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 10px;
    margin-top: 15px;
  }
  .category-top {
    width: 100%;
    display: flex;
    justify-content: space-between;
  }
  #new_category {
    width: 80%;
    height: 42px;
    border-radius: 15px;
    border: solid 2px #cdcad0;
  }
  #addCategoryBtn {
    width: 80px;
    height: 40px;
    border-radius: 10px;
    background: #000;
    color: white;
    border: none;
  }
  [type="checkbox"] {
    width: 25px;
    height: 25px;
    accent-color: black;
    border: 2px;
  }
  label {
    display: flex;
    align-items: center;
  }
  .add-category {
    display: flex;
    align-items: center;
    padding-block: 0.6rem;
    cursor: pointer;
  }
  .category-add {
    display: none;
  }
  .category-add input {
    max-width: 70%;
  }
  .category-add button {
    width: 20%;
    padding-inline: 1rem;
  }
  .add-category img {
    margin-right: 0.7rem;
  }
  .delete-category-btn {
    cursor: pointer;
    display: none;
  }
  .close-arrow {
    margin-block: 1rem;
    cursor: pointer;
  }
</style>
<div id="show-category-slider">
  <img
    class="close-arrow"
    onclick="closeSlide() "
    src="{% static 'images/bxs_down-arrow.svg'%}"
  />
  <div id="category-selection" class="category-selection">
    <div class="category-top">
      <h3>저장 위치</h3>
      <h5 onclick="showDelete()">카테고리 삭제하기</h5>
    </div>
    <div class="add-category" onclick="showInput()">
      <img
        class="add-category-btn"
        src="{% static 'images/category-add-button.svg' %}"
      />
      카테고리 추가하기
    </div>
    <div class="category-add">
      <label for="new_category"></label>
      <input
        type="text"
        id="new_category"
        name="new_category"
        placeholder="카테고리 이름을 입력해주세요."
      />
      <button type="button" id="addCategoryBtn">추가</button>
    </div>
    <div id="category-list">
      {% if user_categories %} {% for category in user_categories %}
      <div class="category-item" data-id="{{ category.id }}">
        <label>
          <input
            class="checkbox"
            type="checkbox"
            name="category"
            value="{{ category.id }}"
          />
          <span class="category-name">{{ category.name }}</span>
        </label>

        <img
          class="delete-category-btn"
          src="{% static 'images/delete.svg' %}"
        />
      </div>
      {% endfor %} {% endif %}
    </div>
  </div>

  <!-- ✅ '나만의 옷장에 저장' 버튼 -->
  <button
    type="button"
    id="saveToClosetBtn"
    class="save-to-closet-btn"
    disabled
  >
    저장
  </button>
  <!-- ✅ 나만의 옷장에 저장 버튼 -->
  <!-- ✅ 업로드된 Outfit ID 표시 -->
  <p id="outfit-id-display">Outfit ID:</p>
</div>

<script>
  let touchStartY = 0;
  let touchEndY = 0;

  document.getElementById("show-category-slider").addEventListener(
    "touchstart",
    function (event) {
      touchStartY = event.touches[0].clientY;
    },
    false
  );

  document.getElementById("show-category-slider").addEventListener(
    "touchmove",
    function (event) {
      touchEndY = event.touches[0].clientY;
    },
    false
  );

  document.getElementById("show-category-slider").addEventListener(
    "touchend",
    function () {
      if (touchEndY - touchStartY > 100) {
        // 100px 이상 아래로 스와이프 시 닫기
        closeSlide();
      }
    },
    false
  );
  function showInput() {
    const categoryInputs = document.querySelectorAll(".category-add");
    categoryInputs.forEach((input) => {
      // 현재 display 상태를 확인하여 반대로 설정
      if (input.style.display === "none" || input.style.display === "") {
        input.style.display = "block";
      } else {
        input.style.display = "none";
      }
    });
  }

  function showDelete() {
    const deleteButtons = document.querySelectorAll(".delete-category-btn");
    deleteButtons.forEach((button) => {
      if (button.style.display === "none" || button.style.display === "") {
        button.style.display = "block";
      } else {
        button.style.display = "none";
      }
    });
  }

  function openSlide() {
    const slideContainer = document.getElementById("show-category-slider");
    slideContainer.style.display = "flex"; // 슬라이드 표시
    setTimeout(() => {
      slideContainer.classList.add("show-slide"); // 애니메이션 적용
    }, 10);
  }

  function closeSlide() {
    const slideContainer = document.getElementById("show-category-slider");
    slideContainer.classList.remove("show-slide");
    setTimeout(() => {
      slideContainer.style.display = "none"; // 닫을 때 완전히 숨김
    }, 300); // 애니메이션 시간과 동일하게 설정
  }

  // ✅ CSRF 토큰 가져오기 함수
  function getCsrfToken() {
    return document.cookie
      .split("; ")
      .find((row) => row.startsWith("csrftoken="))
      ?.split("=")[1];
  }

  // ✅ 카테고리 목록 불러오기
  function loadCategories() {
    fetch("{% url 'closet:usercategory_view' %}") // Django 뷰 호출
      .then((response) => response.json())
      .then((data) => {
        const categoryList = document.getElementById("category-list");
        categoryList.innerHTML = ""; // 기존 목록 초기화

        if (data.categories.length > 0) {
          data.categories.forEach((category) => {
            const categoryDiv = document.createElement("div");
            categoryDiv.classList.add("category-item");
            categoryDiv.setAttribute("data-id", category.id);
            categoryDiv.innerHTML = `
              <label>
                <input type="checkbox" name="category" value="${category.id}" />
                <span class="category-name">${category.name}</span>
              </label>
              <img
          class="delete-category-btn"
          src="{% static 'images/delete.svg' %}"
        />
            `;
            categoryList.appendChild(categoryDiv);
          });
        } else {
          categoryList.innerHTML =
            '<p id="no-category-message">등록된 카테고리가 없습니다.</p>';
        }
      })
      .catch((error) => console.error("카테고리 불러오기 실패:", error));
  }

  // ✅ 카테고리 추가 기능
  document
    .getElementById("addCategoryBtn")
    .addEventListener("click", function () {
      var categoryName = document.getElementById("new_category").value.trim();

      if (!categoryName) {
        alert("카테고리 이름을 입력하세요.");
        return;
      }

      fetch("{% url 'closet:add_category' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": getCsrfToken(),
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ name: categoryName }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            alert("카테고리가 추가되었습니다!");
            loadCategories(); // ✅ 카테고리 목록 다시 불러오기
            document.getElementById("new_category").value = ""; // 입력 필드 초기화
          } else {
            alert(data.error);
          }
        })
        .catch((error) => console.error("카테고리 추가 실패:", error));
    });

  // ✅ 카테고리 삭제 기능 (이벤트 위임 방식)
  document
    .getElementById("category-list")
    .addEventListener("click", function (event) {
      if (event.target.classList.contains("delete-category-btn")) {
        var categoryDiv = event.target.closest(".category-item");
        var categoryId = categoryDiv.getAttribute("data-id");

        if (!confirm("정말 이 카테고리를 삭제하시겠습니까?")) return;

        fetch("{% url 'closet:delete_category' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": getCsrfToken(),
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ id: categoryId }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("카테고리가 삭제되었습니다!");
              loadCategories(); // ✅ 카테고리 목록 다시 불러오기
            } else {
              alert(data.error);
            }
          })
          .catch((error) => console.error("카테고리 삭제 실패:", error));
      }
    });

  // ✅ "나만의 옷장에 저장하기" 버튼 클릭 이벤트

  document
    .getElementById("saveToClosetBtn")
    .addEventListener("click", function () {
      let outfitId = this.getAttribute("data-outfit-id");

      if (!outfitId) {
        alert("먼저 이미지를 업로드하세요!");
        return;
      }

      let selectedCategories = [];
      document
        .querySelectorAll("input[name='category']:checked")
        .forEach((checkbox) => {
          selectedCategories.push(checkbox.value);
        });

      if (selectedCategories.length === 0) {
        alert("최소 한 개의 카테고리를 선택해주세요!");
        return;
      }

      fetch("{% url 'closet:save_outfit_to_closet' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": getCsrfToken(),
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          outfit_id: outfitId,
          category_ids: selectedCategories,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            alert(data.message);
          } else {
            alert(data.error);
          }
        })
        .catch((error) => console.error("오류:", error));
    });

  // ✅ 페이지 로드 시 카테고리 불러오기 실행
  document.addEventListener("DOMContentLoaded", loadCategories);
</script>
