<div class="category-selection">
  <h3>카테고리 목록</h3>
  <div id="category-list">
    {% for category in form.user_category.field.queryset %}
    <div class="category-item" data-id="{{ category.id }}">
      <span class="category-name">{{ category.name }}</span>
      <button class="delete-category-btn">삭제</button>
    </div>
    {% endfor %}
  </div>

  <div class="category-add">
    <label for="new_category">새 카테고리 추가:</label>
    <input
      type="text"
      id="new_category"
      name="new_category"
      placeholder="새 카테고리 입력"
    />
    <button type="button" id="addCategoryBtn">추가</button>
  </div>
</div>

<style>
  .category-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    border-bottom: 1px solid #ddd;
  }

  .category-name {
    font-size: 16px;
  }

  .delete-category-btn {
    background-color: red;
    color: white;
    border: none;
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 5px;
  }

  .delete-category-btn:hover {
    background-color: darkred;
  }
</style>

<script>
  document
    .getElementById("addCategoryBtn")
    .addEventListener("click", function () {
      var categoryName = document.getElementById("new_category").value.trim();

      if (!categoryName) {
        alert("카테고리 이름을 입력하세요.");
        return;
      }

      fetch("{% url 'closet:add_category' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ name: categoryName }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            alert("카테고리가 추가되었습니다!");

            // 새로 추가한 카테고리를 리스트에 추가
            var categoryList = document.getElementById("category-list");

            var categoryDiv = document.createElement("div");
            categoryDiv.classList.add("category-item");
            categoryDiv.setAttribute("data-id", data.id);
            categoryDiv.innerHTML = `
                <span class="category-name">${categoryName}</span>
                <button class="delete-category-btn">삭제</button>
            `;

            categoryList.appendChild(categoryDiv);

            // 삭제 버튼 이벤트 추가
            categoryDiv
              .querySelector(".delete-category-btn")
              .addEventListener("click", function () {
                deleteCategory(data.id, categoryDiv);
              });

            // 입력 필드 초기화
            document.getElementById("new_category").value = "";
          } else {
            alert(data.error);
          }
        });
    });

  // ✅ 카테고리 삭제 기능
  function deleteCategory(categoryId, categoryDiv) {
    if (!confirm("정말 이 카테고리를 삭제하시겠습니까?")) {
      return;
    }

    fetch("{% url 'closet:delete_category' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ id: categoryId }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert("카테고리가 삭제되었습니다!");
          categoryDiv.remove();
        } else {
          alert(data.error);
        }
      });
  }

  // 페이지 로드 후 기존 삭제 버튼에 이벤트 추가
  document.querySelectorAll(".delete-category-btn").forEach((button) => {
    button.addEventListener("click", function () {
      var categoryDiv = this.parentElement;
      var categoryId = categoryDiv.getAttribute("data-id");
      deleteCategory(categoryId, categoryDiv);
    });
  });
</script>
