{% load static %} {% block content %}
<div id="weather"></div>
<div id="outfit-suggestion"></div>

<script>
  const outfitSuggestionsUrl = "{% static 'closet/outfit_suggestions.json' %}"; // JSON 파일 경로

  let outfitSuggestions = {};

  fetch(outfitSuggestionsUrl)
    .then((response) => response.json())
    .then((data) => {
      outfitSuggestions = data;
    })
    .catch((error) => {
      console.error("추천 멘트를 불러오는 데 실패했습니다.", error);
    });

  function success(position) {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;

    // Django 백엔드 API 호출
    fetch(`/api/weather/?lat=${lat}&lon=${lon}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          console.error("Error:", data.error);
        } else {
          displayWeather(data);
          suggestOutfit(data);
        }
      })
      .catch((error) => {
        console.error("날씨 데이터를 불러오는 데 실패했습니다.", error);
      });
  }

  function error() {
    alert("위치 정보를 불러올 수 없습니다.");
  }

  navigator.geolocation.getCurrentPosition(success, error);

  function displayWeather(data) {
    const weatherElement = document.getElementById("weather");
    const temperature = data.main.temp;
    const humidity = data.main.humidity;
    const windSpeed = data.wind.speed;
    const weatherDescription = data.weather[0].description;
    const season = getSeason(temperature);
    const iconCode = data.weather[0].icon;
    const iconUrl = `http://openweathermap.org/img/wn/${iconCode}@2x.png`;

    weatherElement.innerHTML = `
      <h2>현재 날씨</h2>
      <p>온도: ${temperature}°C</p>
      <p>습도: ${humidity}%</p>
      <p>바람: ${windSpeed} m/s</p>
      <p>상태: ${weatherDescription}</p>
      <img src="${iconUrl}" alt="${weatherDescription}">
    `;
  }

  function getSeason(temperature) {
    if (temperature > 20) return "summer";
    else if (temperature <= 20 && temperature > 10) return "spring";
    else if (temperature <= 10 && temperature > 0) return "fall";
    else return "winter";
  }

  function suggestOutfit(data) {
    const outfitElement = document.getElementById("outfit-suggestion");
    const temperature = data.main.temp;
    const humidity = data.main.humidity;
    const windSpeed = data.wind.speed;
    const weatherDescription = data.weather[0].description;
    const season = getSeason(temperature);
    let outfitMessage = "";

    if (weatherDescription.includes("rain")) {
      outfitMessage = outfitSuggestions[season]["rainy"];
    } else if (windSpeed > 5) {
      outfitMessage = outfitSuggestions[season]["windy"];
    } else if (humidity > 80) {
      outfitMessage = outfitSuggestions[season]["humid"];
    } else if (temperature > 30) {
      outfitMessage = outfitSuggestions[season]["hot"];
    } else {
      outfitMessage =
        outfitSuggestions[season]["mild"] || "편안한 옷을 입고 외출하세요!";
    }

    outfitElement.innerHTML = `
      <h3>오늘의 코디 추천</h3>
      <p>${outfitMessage}</p>
    `;
  }
</script>
{% endblock %}
